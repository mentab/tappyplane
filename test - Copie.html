<style type="text/css">
	*
	{
		margin: 0;
		padding: 0;
	}
</style>

<script src="./kaboom/kaboom.js"></script>
<script type="module">

// TODO split in multiple files

const KABOOM_HEIGHT = 480;
const KABOOM_WIDTH = 270;

const SPEED = 350;
const ROCK_OPEN = KABOOM_HEIGHT / 3;
const ROCK_MIN_HEIGHT = KABOOM_HEIGHT / 6;
const JUMP_FORCE = 700;

kaboom({
	global: true,
	scale: window.innerHeight / KABOOM_HEIGHT,
	fullscreen: true,
	clearColor: [0, 0, 0, 1],
	debug: true,
	width: KABOOM_WIDTH,
	height: KABOOM_HEIGHT
});

loadSprite("background", "img/background.png");
loadSprite("ground", "img/ground.png");
loadSprite("plane", "img/plane.png", {
	sliceX: 4,
	sliceY: 1,
	anims:
	{
		fly:
		{
			from: 0,
			to: 3
		}
	}
});
loadSprite("rock", "img/rock.png");
loadSprite("tap", "img/tap.png");
loadSprite("tapLeft", "img/tapLeft.png");
loadSprite("tapRight", "img/tapRight.png");
loadSprite("tapTick", "img/tapTick.png");
loadSprite("textGameOver", "img/textGameOver.png");
loadSprite("textGetReady", "img/textGetReady.png");
loadSprite("medalBronze", "img/medalBronze.png");
loadSprite("medalSilver", "img/medalSilver.png");
loadSprite("medalGold", "img/medalGold.png");
loadSprite("buttonSmall", "img/buttonSmall.png");
loadSprite("buttonLarge", "img/buttonLarge.png");
loadSprite("puffSmall", "img/puffSmall.png");
loadSprite("puffLarge", "img/puffLarge.png");
loadSprite("UIbg", "img/UIbg.png");
loadSound("score", "sound/score.mp3");
loadSound("wooosh", "sound/wooosh.mp3");
loadSound("hit", "sound/hit.mp3");
loadFont("kenvector_future", "font/kenvector_future.png");

function addButton(txt, p, f)
{
	const btn = add([
		sprite("buttonLarge"),
		pos(p),
		scale(.5),
		origin("center")
	]);

	add([
		text(txt, 28),
		pos(p),
		scale(.5),
		origin("center"),
		color(1, 1, 1)
	]);

	btn.action(() =>
	{
		if (btn.isHovered())
		{
			btn.color = rgb(0.8, 0.8, 0.8);

			if (mouseIsClicked())
			{
				f();
			}
		}
		else
		{
			btn.color = rgb(1, 1, 1);
		}
	});
}

function addBackgrounds()
{
	addBackground(0, 0);
	addBackground(799, 0);

	action("backround", (bg) =>
	{
		bg.move(-SPEED / 6, 0)

		if (bg.pos.x <= -799)
		{
			bg.pos.x = 799;
		}
	});

	addGround(0, 0, 1, -1);
	addGround(0, height(), 1, 1);
	addGround(807, 0, 1, -1);
	addGround(807, height(), 1, 1);

	action("ground", (gr) =>
	{
		gr.move(-SPEED / 4, 0)

		if (gr.pos.x <= -807)
		{
			gr.pos.x = 807;
		}
	});
}

function addGround(posX, posY, scaleX, scaleY)
{
	add([
		sprite("ground"),
		layer("obj"),
		origin("botleft"),
		area(vec2(0, 0), vec2(808, -20)),
		pos(posX, posY),
		scale(scaleX, scaleY),
		"ground",
		"dead"
	]);
}

function addBackground(posX, posY)
{
	add([
		sprite("background"),
		pos(posX, posY),
		layer("background"),
		"backround"
	]);
}

scene("menu", () =>
{
	layers([
		"background",
		"obj",
		"ui",
	], "obj");

	addBackgrounds();

	addButton("START", vec2(width() / 2 - width() / 4, height() / 1.5), () => { go("main"); });
	addButton("SCORES", vec2(width() / 2 + width() / 4, height() / 1.5), () => { go("score"); });

	const plane = add([
		sprite("plane"),
		pos(width() / 4, height() / 2),
		origin("center"),
		scale(.5)
	]);

	plane.play("fly");

	// TODO add title

	add([
		sprite("textGetReady"),
		pos(width() / 2, height() / 3),
		origin("center"),
		scale(.5),
		"starting",
		layer("ui")
	]);
});

scene("main", () => {

	let started = false;

	// debug.inspect = true;

	gravity(0);

	layers([
		"background",
		"obj",
		"ui",
	], "obj");

	addBackgrounds();

	add([
		sprite("textGetReady"),
		pos(width() / 2, height() / 3),
		origin("center"),
		scale(.5),
		"starting",
		layer("ui")
	]);

	add([
		sprite("tapLeft"),
		pos(width() / 3 + width() / 5, height() / 2 + height() / 16),
		origin("center"),
		scale(.5),
		"starting",
		layer("ui")
	]);

	add([
		sprite("tapTick"),
		pos(width() / 3 + width() / 10, height() / 2 + height() / 12),
		origin("center"),
		scale(.5),
		"starting",
		layer("ui")
	]);

	add([
		sprite("puffLarge"),
		rotate(1.5),
		pos(width() / 3 + width() / 10, height() / 2),
		origin("center"),
		color(rgba(.5, .5, .5, .5)),
		scale(.5),
		"starting",
		layer("ui")
	]);

	add([
		sprite("plane"),
		pos(width() / 3 + width() / 10, height() / 2 - height() / 16),
		origin("center"),
		color(rgba(.5, .5, .5, .5)),
		scale(.5),
		"starting",
		layer("ui")
	]);

	const plane = add([
		sprite("plane"),
		pos(width() / 4, height() / 2),
		origin("center"),
		scale(.5),
		area(vec2(-15, -15), vec2(25, 20)),
		body(),
	]);

	plane.play("fly");

	keyPress("space", () =>
	{
		if (!started)
		{
			started = true;

			destroyAll("starting");

			gravity(2400);
		}

		plane.jump(JUMP_FORCE);

		play("wooosh");
	});

	function spawnRock()
	{
		const h1 = rand(ROCK_MIN_HEIGHT, height() - ROCK_MIN_HEIGHT - ROCK_OPEN);
		const h2 = h1 + ROCK_OPEN;

		add([
			sprite("rock"),
			origin("botleft"),
			area(vec2(35, 0), vec2(45, -240)),
			pos(width(), h1),
			"rock",
			"dead"
		]);

		add([
			sprite("rock"),
			origin("botleft"),
			area(vec2(35, 0), vec2(45, -240)),
			scale(1, -1),
			pos(width(), h2),
			"rock",
			"dead",
			{ passed: false }
		]);
	}

	plane.collides("dead", () =>
	{
		go("death", score.value);
		play("hit");
	});

	action("rock", (p) =>
	{
		p.move(-SPEED, 0);

		if (p.pos.x + p.width <= plane.pos.x && p.passed === false)
		{
			addScore();
			p.passed = true;
		}

		if (p.pos.x < -width() / 2)
		{
			destroy(p);
		}
	});

	loop(1, () =>
	{
		if (started)
		{
			spawnRock();
		}
	});

	// TODO add image for score instead of text

	const score = add([
		text("0", 28),
		layer("ui"),
		pos(width() / 2, height() / 6),
		{
			value: 0,
		},
	]);

	function addScore()
	{
		score.value++;
		score.text = score.value;
		play("score");
	}

	keyDown("up", () =>
	{
		camScale(camScale().add(vec2(dt())));
	});

	keyDown("down", () =>
	{
		camScale(camScale().sub(vec2(dt())));
	});
});

scene("death", (score) =>
{
	layers([
		"background",
		"obj",
		"ui",
	], "obj");

	addBackgrounds();

	add([
		sprite("textGameOver"),
		pos(width() / 2, height() / 2 - 180),
		origin("center"),
		scale(.5),
		layer("ui")
	]);

	add([
		sprite("UIbg"),
		pos(width() / 2, height() / 2),
		origin("center"),
		layer("ui")
	]);

	add([
		text('MEDAL', 18),
		pos(width() / 2 - 120, height() / 2 - 110),
		layer("ui")
	]);

	var spriteMedal = "";

	if (score > 100)
	{
		spriteMedal = "medalGold";
	}
	else if (score > 50)
	{
		spriteMedal = "medalSilver";
	}
	else if (score > -1)
	{
		spriteMedal	=	"medalBronze";
	}

	if (spriteMedal)
	{
		add([
			sprite(spriteMedal),
			pos(width() / 2 - 105, height() / 2 - 70),
			scale(.5),
			layer("ui")
		]);
	}

	add([
		text('SCORE', 18),
		pos(width() / 2 + 10, height() / 2 - 110),
		layer("ui")
	]);

	add([
		text(score, 36),
		pos(width() / 2 + 10, height() / 2 - 70),
		layer("ui")
	]);

	add([
		text('BEST', 18),
		pos(width() / 2 + 10, height() / 2),
		layer("ui")
	]);

	add([
		text(JSON.parse(localStorage.getItem('scores')).sort((a, b) => a - b).reverse().slice(0, 1), 36),
		pos(width() / 2 + 10, height() / 2 + 40),
		layer("ui")
	]);

	if (!localStorage.getItem('scores'))
	{
		localStorage.setItem('scores', JSON.stringify([score]));
	}
	else
	{
		localStorage.setItem('scores', JSON.stringify(JSON.parse(localStorage.getItem('scores')).sort((a, b) => a - b).reverse().slice(0, 10).concat(score)));
	}

	addButton("OK", vec2(width() / 2 - 80, height() / 2 + 180), () => { go("menu"); });
});

scene("score", () =>
{
	layers([
		"background",
		"obj",
		"ui",
	], "obj");

	addBackgrounds();

	add([
		sprite("UIbg"),
		pos(width() / 2, height() / 2),
		origin("center"),
		layer("ui")
	]);

	let heightSub	=	110;

	add([
		text('SCORES', 18),
		pos(width() / 2 - 120, height() / 2 - heightSub),
		layer("ui")
	]);

	let scores	=	JSON.parse(localStorage.getItem('scores')).sort((a, b) => a - b).reverse().slice(0, 3);

	// TODO add Medal

	for (const score of scores)
	{
		heightSub	=	heightSub - 40;

		add([
			text(score, 18),
			pos(width() / 2 - 120, height() / 2 - heightSub),
			layer("ui")
		]);
	}

	addButton("OK", vec2(width() / 2 - 80, height() / 2 + 180), () => { go("menu"); });
});

start("menu");

</script>